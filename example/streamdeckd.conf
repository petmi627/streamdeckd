eventloop {
     policy uvloop:EventLoopPolicy;
}

logger {
    format "%(levelname)s - %(message)s";
    level INFO;
}

# Loads an extension.
# A extension is a module placed in streamdeckd.ext 
#
# The module must have the functions
# - load(app: streamdeckd.application.Streamdeckd, ctx: streamdeckd.config.applicaiton.ApplicationContext) -> None
#   Add new configuration options.
#   To add new root configuration options, monkey-patch this class by adding a new method to the instance.
#
# - start(app: streamdeckd.application.Streamdeckd) -> Awaitable[None]
#   This coroutine is called when the streamdeck starts.
#
# - stop(app: streamdeckd.application.Streamdeckd) -> Awaitable[None]
#   This coroutine is run when streamdeck stops.
load http;

# Scan for new devices every ten seconds.
rescan 10s;


load strings;
# The line "load strings;" has enabled this command.
split_variable ip "{raw_ip}" ".";

# The streamdeck directive can 
streamdeck '*' default {
    fps 5;
    brightness 1;

    font "FreeMono.ttf";
    size 12;

    connected {
        http get "https://api.ipify.org/?format=txt" {
            header "User-Agent" "Streamdeckd/0.1.0";
            variable "raw_ip";
            parser "text";
        }
    }

    menu "Main" default {
        button 0 0 {
            text "Config";
            image "example/keys/elgato_key.png";

            released {
                menu "Config";
            }
        }

        button 4 0 {
            image "example/keys/elgato_exit.png";

            state "Off" default {
                text "Exit";

                released {
                    state "Armed";
                }

            }

            state "Armed" default {
                text "Sure?";
                bg "#400";

                entered {
                    delay 10s;
                    state "Off";
                }

                released {
                    exit;
                }
            }
        }

        button 3 0 {
            image "example/keys/elgato_exit.png";

            state "Off" default {
                text "Shutdown";

                released {
                    state "Armed";
                }
            }

            state "Armed" {
                text "Sure?";
                bg "#400";

                entered {
                    delay 2s;
                    state "Off";
                }

                released {
                    run 'dbus-send --system --print-reply --dest=org.freedesktop.login1 /org/freedesktop/login1 "org.freedesktop.login1.Manager.PowerOff" boolean:true';
                }
            }
        }

        button 4 1 {
            text "{ip:3}";
        }

        button 3 1 {
            text "{ip:2}";
        }

        button 2 1 {
            text "{ip:1}";
        }

        button 1 1 {
            text "{ip:0}";
        }

        button 1 2 {
            font "FreeMono.ttf";
            size 20;
            image "";

            state "Time" default {
                text "{now:%H}";
            }

            state "Date" {
                text "{now:%d}";
            }
        }
        button 2 2 {
            font "FreeMono.ttf";
            size 20;
            image "";

            state "Time" default {
                text "{now:%M}";
            }

            state "Date" {
                text "{now:%m}";
            }
        }
        button 3 2 {
            font "FreeMono.ttf";
            size 20;
            image "";

            state "Time" default {
                text "{now:%S}";
            }

            state "Date" {
                text "{now:%y}";
            }
        }
        button 0 2 {
            text "Date";

            state "Off" default {
                bg "#000";
                entered {
                    log "Executed";

                    parallel {
                        button 1 2 {
                            state "Time";
                        }
                        button 2 2 {
                            state "Time";
                        }
                        button 3 2 {
                            state "Time";
                        }
                    }
                }

                released {
                    state "On";
                }
            }

            state "On" default {
                bg "#040";
                entered {
                    log "Executed";

                    parallel {
                        button 1 2 {
                            state "Date";
                        }
                        button 2 2 {
                            state "Date";
                        }
                        button 3 2 {
                            state "Date";
                        }
                    }
                }

                released {
                    state "Off";
                }
            }
        }
    }

    menu "Config" {
        button 0 0 {
            text "Back";

            pressed {
                menu "Main";
            }
        }

        button 0 1 {
            image "example/keys/elgato_brightness.png";
            text "{state}%";

            state "100" default {
                entered {
                    brightness 1;
                }

                released {
                    state "75";
                }
            }

            state "75" {
                entered {
                    brightness 0.75;
                }

                released {
                    state "50";
                }
            }

            state "50" {
                entered {
                    brightness 0.5;
                }

                released {
                    state "25";
                }
            }

            state "25" {
                entered {
                    brightness 0.25;
                }

                released {
                    state "0";
                }
            }

            state "0" {
                entered {
                    brightness 0;
                }

                released {
                    state "100";
                }
            }
        }
    }
}